---
- name: install nginx
  yum: name=nginx

- name: add nginx to groups
  user:
    name: nginx
    append: yes
    groups: "{{ item }}"
  with_items: "{{ nginx_groups }}"
  notify: restart nginx

- name: configure nginx
  template:
    src: nginx.conf
    dest: /etc/nginx/nginx.conf
    owner: root
    group: root
    mode: 0644
  notify: reload nginx
  register: configure_result

- name: configure ssl
  include: ssl-configure.yml

- name: selfsign ssl certificates
  include: ssl-selfsign.yml
  args:
    common_name: "{{ item.name }}"
  with_items: "{{ nginx_vhosts }}"

- name: configure extras
  include: nginx-extras.yml

- name: configure vhosts
  include: nginx-vhost.yml
  args:
    vhost_name: "{{ item.name }}"
    vhost_default: "{{ item.default|default(true) }}"
    vhost_pool: "{{ item.pool }}"
    vhost_params: "{{ item.params|default({}) }}"
  with_items: "{{ nginx_vhosts }}"

- name: configure backends
  include: nginx-backend.yml
  args:
    backend_name: "{{ item.name }}"
    backend_pool: "{{ item.pool }}"
    backend_listen: "{{ item.listen }}"
    backend_webroot: "{{ item.webroot }}"
  with_items: "{{ nginx_backends }}"

- name: configure domain redirects
  include: domain-redirect.yml
  args:
    redirect_domain: "{{ item.domain }}"
    redirect_target: "{{ item.target }}"
    redirect_include_uri: "{{ item.include_uri|default(false) }}"
  with_items: "{{ nginx_domain_redirects }}"

# Ensure nginx is started and enabled in chkconfig
- name: start nginx service
  service:
    name: nginx
    state: started
    enabled: yes

# reload nginx now if nginx.conf was touched; this allows nginx to disassociate with previous user
- name: restart nginx service
  service: name=nginx state=restarted
  when: configure_result|changed
